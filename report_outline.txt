项目报告大纲（txt）——Multi-Agent Code Generation System（arXiv CS Daily Case）

0. 封面信息
- 课程/作业信息：COMP7103C Course Assignment
- 项目名称：Multi-Agent Code Generation System
- 典型用例：arXiv CS Daily Website Generator
- 作者/日期/环境（Windows + Python）

1. 摘要（Abstract）
1.1 项目目标概述
- 输入：自然语言需求（默认：prompts/system_prompts.py 中 ARXIV_PROJECT_REQUIREMENT）
- 输出：完整可运行的前端网站项目（outputs/ 下 HTML/CSS/JS/JSON）
1.2 方法概述
- 多代理协作：PlanningAgent + CodeGenerationAgent + EvaluationAgent
- 编排器：MultiAgentOrchestrator 分阶段调度
- 工具调用：FileTools + LLMClient（以及可选 arXiv/web search/command tools）
1.3 结果概述
- 生成文件清单与核心功能
- 评估结果：overall_score=88/100（outputs/state/state.json）

2. 引言（Introduction）
2.1 背景与动机
- 大模型在软件工程中的应用：从“需求”到“工程化产物”的自动化
- 多代理分工带来的可控性与可扩展性
2.2 需求与任务定义
- 默认项目需求：arXiv CS Daily（导航、列表、详情页、引用生成、数据源等）
- 运行方式与参数：main.py（--provider/--model/--mock/--output-dir/--max-iterations）
2.3 贡献点（Contributions）
- 可复用的多代理编排框架
- 统一消息协议 protocol/message_schema.py
- 状态持久化与记忆恢复 state/state_manager.py

3. System Design（系统设计）
3.1 总体架构与分层
- 应用层：main.py（参数解析、日志初始化、启动 orchestrator）
- 编排层：orchestrator/multi_agent_orchestrator.py
- 代理层：agents/base_agent.py、agents/code_agent.py、agents/evaluation_agent.py
- 工具层：tools/file_tools.py、tools/llm_client.py（以及 tools/arxiv_tools.py、tools/web_search_tools.py、tools/command_tools.py 如启用）
- 状态层：state/state_manager.py（输出侧 state 位于 outputs/state/state.json）

3.2 核心执行流程（Phase-based Workflow）
- Phase 1：规划（Planning）
  - 输入：requirement
  - 输出：project_plan（JSON：project_name/technology_stack/file_structure/tasks）
- Phase 2：代码生成（Code Generation）
  - 任务调度：priority + dependencies（_sort_tasks/_check_dependencies）
  - 工具调用：create_file/write_to_file/read_file/list_directory
  - 上下文注入：completed_tasks、created_files、recent_tasks、recent_files
- Phase 3：评估（Evaluation）
  - 读取生成文件进行评审
  - 输出 evaluation JSON（score/issues/strengths/recommendations）

3.3 Agent 设计（职责与接口）
- PlanningAgent（agents/base_agent.py）
  - 需求解析、架构建议、任务拆解
  - 计划 JSON 解析：从 LLM 返回文本中提取 JSON（含 fallback plan）
- CodeGenerationAgent（agents/code_agent.py）
  - 面向单任务生成代码
  - 支持工具调用循环（max_iterations=5）
  - 兜底策略：无 tool_calls 时尝试 fallback file creation
- EvaluationAgent（agents/evaluation_agent.py）
  - 汇总文件内容形成评估 prompt
  - 可选：command_tools.run_tests() 将自动化检查纳入评估

3.4 通信协议（Message Schema & Traceability）
- 统一消息：AgentMessage + MessageType（protocol/message_schema.py）
- 关键消息类型：plan_request/plan_response、task_assignment/task_result、evaluation_request/evaluation_report
- 记录机制：BaseAgent.record_protocol_message 将协议消息写入 conversation_history（便于审计与复现）

3.5 状态与记忆（State & Memory）
- StateManager（state/state_manager.py）
  - state.json 字段：project_plan/completed_tasks/created_files/task_results/evaluation/agents/last_updated
  - agent memory：conversation_history + thoughts（export_memory/load_memory）
- 设计目的
  - 支持中断恢复与跨阶段共享上下文
  - 提供“最近任务/最近文件”作为短期记忆（get_recent_tasks/get_recent_files）

3.6 工具层与外部依赖
- LLMClient（tools/llm_client.py）
  - provider：deepseek/openai/anthropic
  - API 协议适配：OpenAI-style 与 Anthropic 两类请求
  - 无 key 时降级到 EnhancedMockLLMClient（main.py）
- FileTools（tools/file_tools.py）
  - base_dir 默认 outputs
  - create_file/write_to_file/read_file/list_directory 的统一返回结构
- 配置（config/config.py）
  - LLM_CONFIG/ALTERNATIVE_LLMS/ORCHESTRATOR_CONFIG 等

3.7 生成产物结构（Generated Artifacts）
- outputs/ 典型文件：index.html、category.html、paper.html、css/style.css、js/script.js、data/papers.json、USAGE.md、state/state.json
- 关键前端数据流
  - js/script.js：fetch('data/papers.json') -> 渲染分类/列表/详情 -> 引用生成与复制

4. Key Challenges and Solutions（关键挑战与解决方案）
4.1 需求到可执行任务的结构化表达
- 挑战：LLM 返回可能包含非 JSON 文本或格式偏差
- 方案：PlanningAgent 从文本中截取 JSON（find '{' 到 rfind '}'），失败则 fallback plan

4.2 多代理协作的一致性与上下文对齐
- 挑战：分工后信息丢失、重复生成、任务依赖失序
- 方案
  - orchestrator 统一调度（依赖检查 + 优先级排序）
  - context 注入（completed_files/completed_tasks/recent_files）
  - state 持久化：state_manager.update + record_agent_memory

4.3 工具调用的可靠性（Function Calling Robustness）
- 挑战：LLM 可能多次重复调用 create_file，导致 created_files 记录重复（state.json 中可观察）
- 方案（报告可写“已实现/拟改进”二选一）
  - 已实现：通过工具返回结构化结果推进对话
  - 拟改进：对 files_created 去重；在 orchestrator 层合并 created_files；加入幂等性校验

4.4 提供商差异与可移植性（Provider Compatibility）
- 挑战：DeepSeek/OpenAI/Anthropic API 协议不同，工具格式也有差异
- 方案：LLMClient 抽象统一 chat 接口，并提供 _convert_tools_to_anthropic 适配

4.5 可复现与可调试性
- 挑战：自动生成系统难以追踪“为什么这样生成”
- 方案
  - 统一日志：main.py + orchestrator logger（logs/agent_system_*.log）
  - thoughts 记录：BaseAgent.add_thought
  - 统一协议消息：可回放关键交互

4.6 数据真实性与外部接口依赖（arXiv API）
- 挑战：需求强调“必须使用 arXiv API 获取真实论文”，但在 mock/离线条件下难以保证
- 方案（建议写在实现差距与未来工作中）
  - 引入 tools/arxiv_tools.py 与脚本 scripts/fetch_papers.py（需求侧要求）
  - 在无网络/无 key 时降级为样例数据，同时在报告中明确限制

5. Results Analysis（结果分析）
5.1 功能完成度（按需求对照）
- 导航系统
  - index.html：分类导航与入口
  - category.html：按 URL 参数 category 过滤
- 列表与详情
  - category.html：卡片展示 title/authors/category/submitted/abstract
  - paper.html：详情 + PDF/arXiv 链接 + 引用生成
- 引用生成
  - js/script.js：BibTeX 与标准引用字符串生成 + 复制

5.2 生成产物与结构质量
- 产物清单：见 outputs/ 与 outputs/USAGE.md
- 代码组织：静态前端（HTML/CSS/Vanilla JS）+ JSON 数据文件

5.3 数据规模与覆盖
- outputs/data/papers.json
  - papers 数量：当前示例为 8 篇（USAGE.md）
  - category 覆盖：AI/CV/LG/CL/RO/CR 等
- 与原始需求对比
  - 需求期望：多类别、25-30 篇、真实 arXiv 数据
  - 当前结果：示例数据可运行，但真实性/规模可能不足（需在反思中说明）

5.4 评估结果解读
- evaluation（outputs/state/state.json）
  - overall_score：88/100，passed=true
  - issues（低严重度）：建议增加 fetch 失败的用户友好提示/错误处理
  - strengths：语义化 HTML、响应式设计、JS 功能完整、导航直观等
  - recommendations：loading indicator、搜索、分页

5.5 测试与验证
- test_system.py
  - 覆盖：import、FileTools、mock client、agent 初始化、生成文件存在性、papers.json 合法性
- 运行方式（可写在附录或实验部分）
  - python main.py --mock / python test_system.py

6. Reflections（反思）
6.1 经验与收获
- 多代理分工提升可控性：规划/实现/评估的职责边界更清晰
- 协议化消息与状态持久化提升可复现性与可调试性

6.2 局限性
- “真实 arXiv 数据”依赖外部网络与 API 工具，mock 模式下无法满足真实性要求
- 工具调用幂等性不足可能导致重复文件记录（created_files 重复）
- 评估阶段偏主观：缺少更强的自动化测试/静态分析

6.3 改进方向（Future Work）
- 数据侧
  - 落地 scripts/fetch_papers.py（按需求：调用 arXiv API 写入 data/papers.json）
  - 引入缓存与增量更新，保证“Daily”属性
- 前端侧
  - 增加 loading/error UI、搜索与分页
  - 增强可访问性（ARIA、键盘操作）
- 系统侧
  - created_files 去重与任务幂等
  - 更严格的 schema 校验（plan/evaluation）
  - 集成 lint/unit test（command_tools.run_tests）并纳入 evaluation

7. 结论（Conclusion）
- 总结系统在“从自然语言到可运行项目”上的有效性
- 强调多代理架构、工具调用与状态持久化的价值

8. 附录（Appendix，可选）
8.1 关键文件索引
- main.py
- orchestrator/multi_agent_orchestrator.py
- agents/base_agent.py、agents/code_agent.py、agents/evaluation_agent.py
- tools/llm_client.py、tools/file_tools.py
- protocol/message_schema.py
- state/state_manager.py
- outputs/*（生成结果）

8.2 运行命令与参数说明
- python main.py [--mock] [--provider deepseek|openai|anthropic] [--output-dir ...] [--max-iterations N]
- python test_system.py
